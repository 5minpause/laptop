#!/usr/bin/env sh
#
# Laptop by thoughtbot
#
###
set -e

# UI
################################################################################
info() {
  local fmt="$1"; shift
  printf ":: $fmt\n" "$@"
}

error() {
  local fmt="$1"; shift
  printf "ERROR: $fmt\n" "$@"
}

# Support
################################################################################
die() { error "$@"; exit 1; }

write_to_file() {
  local file="$1"; shift

  printf "%s\n" "$@" >> "$file"
}

run_step() {
  local function="$1" description="$2"; shift 2

  info "%s..." "$description"
  $function "$@" || die "Failure in %s" "$function"
}

# Shared commands
################################################################################
set_shell() {
  chsh -s $(which zsh)
}

install_ruby() {
  rbenv install "$ruby_version"
  rbenv global "$ruby_version"
  rbenv rehash
}

install_gems() {
  gem update --system
  gem install bundler --no-document --pre
  gem install rails --no-document
}

install_hub() {
  local bin="$HOME/.bin"

  if [ ! -d "$bin" ]; then
    mkdir "$bin"
  fi

  if ! echo ":${PATH}:" | grep -Fq ":${bin}:"; then
    write_to_file ~/.zshrc "export PATH=\"${bin}:\$PATH\""
    export PATH="${bin}:$PATH"
  fi

  curl http://hub.github.com/standalone -sLo ~/.bin/hub
  chmod +x ~/.bin/hub
}

configure_bundler() {
  bundle config --global jobs $((number_of_cores - 1))
}

install_heroku_config() {
  heroku plugins:install git://github.com/ddollar/heroku-config.git
}

# OS-specific commands
################################################################################
install() { sudo aptitude install -y "$@"; }

supported() {
  grep -iq 'precise\|quantal\|wheezy\|raring\|jessie\|saucy' /etc/os-release
}

update() {
  if ! command -v aptitude >/dev/null; then
    sudo apt-get install -y aptitude
  fi

  sudo aptitude update
}

setup() {
  install \
    curl \
    zsh \
    libcurl4-openssl-dev \
    libksba-dev \
    libksba8 \
    libqtwebkit-dev \
    libreadline-dev \
    libxslt1-dev
}

install_postgresql() {
  install postgresql postgresql-server-dev-all
}

install_system_packages() {
  install \
    exuberant-ctags \
    git \
    imagemagick \
    redis-server \
    tmux \
    vim-gtk \
    watch
}

install_silversearcher() {
  git clone 'git://github.com/ggreer/the_silver_searcher.git' /tmp/the_silver_searcher
  install -y automake pkg-config libpcre3-dev zlib1g-dev liblzma-dev
  sh /tmp/the_silver_searcher/build.sh
  cd /tmp/the_silver_searcher
  sh build.sh
  sudo make install
  cd && rm -rf /tmp/the_silver_searcher
}

ruby_prerequisites() {
  sudo aptitude build-dep -y ruby1.9.3
}

install_rbenv() {
  git clone git://github.com/sstephenson/rbenv.git ~/.rbenv

  if ! grep -Fsq 'rbenv init' ~/.zshrc; then
    write_to_file ~/.zshrc \
      'export PATH="$HOME/.rbenv/bin:$PATH"' \
      'eval "$(rbenv init - --no-rehash)"'

    export PATH="$HOME/.rbenv/bin:$PATH"
    eval "$(rbenv init - --no-rehash)"
  fi
}

install_ruby_build() {
  git clone 'https://github.com/sstephenson/rbenv-gem-rehash.git' \
    ~/.rbenv/plugins/rbenv-gem-rehash
}

install_gem_rehash() {
  git clone 'git://github.com/sstephenson/ruby-build.git' \
    ~/.rbenv/plugins/ruby-build
}

install_heroku_toolbelt() {
  wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh
}

install_rcm() {
  wget -O /tmp/rcm_1.1.0_all.deb http://mike-burns.com/project/rcm/rcm_1.1.0_all.deb
  sudo dpkg -i /tmp/rcm_1.1.0_all.deb
  rm -f /tmp/rcm_1.1.0_all.deb
}

number_of_cores=$(nproc)
ruby_version="${RUBY_VERSION:-2.1.0}"

# Shared Installation steps
################################################################################
supported || die 'Your OS is not supported by laptop'

run_step update 'Updating the system'
run_step setup 'Preparing the system'
run_step install_system_packages 'Installing useful system packages'
run_step install_silversearcher 'Installing The Silver Searcher (better than ack or grep) to search the contents of files'
run_step install_postgresql 'Installing Postgres, a good open source relational database'
run_step install_rbenv 'Installing rbenv, to change Ruby versions'
run_step install_gem_rehash 'Installing rbenv-gem-rehash so the shell automatically picks up binaries after installing gems with binaries'
run_step install_ruby_build 'Installing ruby-build, to install Rubies'
run_step ruby_prerequisites 'Installing Ruby dependencies'
run_step install_ruby 'Installing Ruby $ruby_version and setting as global'
run_step install_gems 'Installing Bundler and Rails'
run_step configure_bundler 'Configuring Bundler for faster, parallel gem installation'
run_step install_hub 'Installing GitHub CLI client'
run_step install_heroku_toolbelt 'Installing Heroku CLI client'
run_step install_heroku_config 'Installing the heroku-config plugin to pull config variables locally to be used as ENV variables'
run_step install_rcm 'Installing rcm, to manage your dotfiles'
run_step set_shell 'Setting ZSH as your login shell'
